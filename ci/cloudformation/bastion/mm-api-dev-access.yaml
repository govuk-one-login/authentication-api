AWSTemplateFormatVersion: "2010-09-09"
Description: "Dev API proxy infrastructure for development environments"

Parameters:
  AwsRegion:
    Type: String
    Default: eu-west-2
    Description: AWS Region
  DevApiStackName:
    Type: String
    Description: Name of the dev API stack to import API Gateway ID from
    Default: am-api
  Authdev3ApiStackName:
    Type: String
    Description: Name of the authdev3 API stack to import API Gateway ID from
    Default: authdev3-am-api
  VpcStackName:
    Type: String
    Description: Name of the VPC stack to import values from
    Default: vpc

Resources:
  # IAM Role for Dev Proxy
  DevProxyRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: dev-proxy-role
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
        - arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy

  # KMS Access Policy
  DevProxyKMSAccessPolicy:
    Type: AWS::IAM::RolePolicy
    Properties:
      RoleName: !Ref DevProxyRole
      PolicyName: dev-proxy-kms-access
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Sid: AllowGetParameters
            Effect: Allow
            Action:
              - kms:Decrypt
            Resource: !Sub "arn:aws:kms:${AwsRegion}:${AWS::AccountId}:key/*"

  # Instance Profile
  DevProxyInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      InstanceProfileName: dev-proxy-profile
      Roles:
        - !Ref DevProxyRole

  # SSM Document for Port Forwarding
  DevPortForwardDocument:
    Type: AWS::SSM::Document
    Properties:
      Name: dev-mm-api-dev-proxy-ssm-document
      DocumentType: Session
      Content:
        schemaVersion: "1.0"
        description: "Document to start an Account Management API forwarding session over Session Manager"
        sessionType: Port
        parameters:
          localPortNumber:
            type: String
            description: "(Optional) Port number on local machine to forward traffic to. An open port is chosen at run-time if not provided"
            allowedPattern: "^([0-9]|[1-9][0-9]{1,3}|[1-5][0-9]{4}|6[0-4][0-9]{3}|65[0-4][0-9]{2}|655[0-2][0-9]|6553[0-5])$"
            default: "0"
        properties:
          portNumber: "80"
          type: LocalPortForwarding
          localPortNumber: "{{ localPortNumber }}"

  # Security Group for Dev Proxy
  DevProxySecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: dev-proxy-sg
      GroupDescription: Security group for Dev API proxy
      VpcId:
        Fn::ImportValue: !Sub ${VpcStackName}-VpcId
      SecurityGroupEgress:
        - Description: Allow outbound traffic to vpc endpoints
          IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          DestinationSecurityGroupId:
            Fn::ImportValue: !Sub ${VpcStackName}-AWSServicesEndpointSecurityGroupId
        - DestinationPrefixListId: pl-7ca54015
          Description: Allow outgoing HTTPS requests to AWS S3 route from security group
          IpProtocol: tcp
          FromPort: 443
          ToPort: 443

  # EC2 Instance for Dev Proxy
  DevProxyInstance:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: ami-09eaa54de6f278f78
      InstanceType: t4g.nano
      SubnetId:
        Fn::ImportValue: !Sub "${VpcStackName}-PrivateSubnetIdA"
      SecurityGroupIds:
        - !Ref DevProxySecurityGroup
      IamInstanceProfile: !Ref DevProxyInstanceProfile
      Monitoring: true
      MetadataOptions:
        HttpTokens: required
      UserData:
        Fn::Base64: !Sub
          - |
            #cloud-config
            package_update: true
            package_upgrade: true

            packages:
              - nginx

            write_files:
              - path: /etc/nginx/conf.d/api-proxy.conf
                content: |
                  server {
                      listen 80;
                      server_name _;

                      # Debug request details
                      add_header X-Debug-Host $host;
                      add_header X-Debug-Uri $request_uri;

                      location / {
                          # This maps the request path correctly - using literal variable
                          rewrite ^/(.*) /dev/$1 break;

                          # Set the proper Host header for API Gateway
                          proxy_set_header Host ${DevApiGatewayId}.execute-api.eu-west-2.amazonaws.com;

                          # Pass the actual VPC endpoint - without https:// in proxy_pass
                          proxy_pass https://vpce-0b907325ae3bfe3ce-0q79qfb6.execute-api.eu-west-2.vpce.amazonaws.com;

                          # Forward the authorization header
                          proxy_set_header Authorization $http_authorization;
                          proxy_pass_request_headers on;

                          # Add additional headers for debugging
                          proxy_set_header X-Real-IP $remote_addr;
                          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                          proxy_set_header X-Original-URI $request_uri;

                          # SSL verification settings for connecting to VPC endpoint
                          proxy_ssl_verify off;
                      }
                  }
                owner: root:root
                permissions: '0644'
              - path: /etc/sudoers.d/ssm-agent-users
                content: |
                  # User rules for ssm-user
                owner: root:root
                permissions: '0440'

            runcmd:
              - systemctl enable nginx
              - systemctl start nginx
          - DevApiGatewayId:
              Fn::ImportValue: !Sub "${DevApiStackName}-AccountManagementApiId"
      Tags:
        - Key: Name
          Value: dev-am-api-proxy-host

  # Authdev3 Bastion Host Resources
  Authdev3ProxyRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: authdev3-proxy-role
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
        - arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy

  Authdev3ProxyKMSAccessPolicy:
    Type: AWS::IAM::RolePolicy
    Properties:
      RoleName: !Ref Authdev3ProxyRole
      PolicyName: authdev3-proxy-kms-access
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Sid: AllowGetParameters
            Effect: Allow
            Action:
              - kms:Decrypt
            Resource: !Sub "arn:aws:kms:${AwsRegion}:${AWS::AccountId}:key/*"

  Authdev3ProxyInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      InstanceProfileName: authdev3-proxy-profile
      Roles:
        - !Ref Authdev3ProxyRole

  Authdev3PortForwardDocument:
    Type: AWS::SSM::Document
    Properties:
      Name: authdev3-mm-api-authdev3-proxy-ssm-document
      DocumentType: Session
      Content:
        schemaVersion: "1.0"
        description: "Document to start an Account Management API forwarding session over Session Manager for Authdev3"
        sessionType: Port
        parameters:
          localPortNumber:
            type: String
            description: "(Optional) Port number on local machine to forward traffic to. An open port is chosen at run-time if not provided"
            allowedPattern: "^([0-9]|[1-9][0-9]{1,3}|[1-5][0-9]{4}|6[0-4][0-9]{3}|65[0-4][0-9]{2}|655[0-2][0-9]|6553[0-5])$"
            default: "0"
        properties:
          portNumber: "80"
          type: LocalPortForwarding
          localPortNumber: "{{ localPortNumber }}"

  Authdev3ProxySecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: authdev3-proxy-sg
      GroupDescription: Security group for authdev3 API proxy
      VpcId:
        Fn::ImportValue: !Sub ${VpcStackName}-VpcId
      SecurityGroupEgress:
        - Description: Allow outbound traffic to vpc endpoints
          IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          DestinationSecurityGroupId:
            Fn::ImportValue: !Sub ${VpcStackName}-AWSServicesEndpointSecurityGroupId
        - DestinationPrefixListId: pl-7ca54015
          Description: Allow outgoing HTTPS requests to AWS S3 route from security group
          IpProtocol: tcp
          FromPort: 443
          ToPort: 443

  Authdev3ProxyInstance:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: ami-09eaa54de6f278f78
      InstanceType: t4g.nano
      SubnetId:
        Fn::ImportValue: !Sub "${VpcStackName}-PrivateSubnetIdA"
      SecurityGroupIds:
        - !Ref Authdev3ProxySecurityGroup
      IamInstanceProfile: !Ref Authdev3ProxyInstanceProfile
      Monitoring: true
      MetadataOptions:
        HttpTokens: required
      UserData:
        Fn::Base64: !Sub
          - |
            #cloud-config
            package_update: true
            package_upgrade: true

            packages:
              - nginx

            write_files:
              - path: /etc/nginx/conf.d/api-proxy.conf
                content: |
                  server {
                      listen 80;
                      server_name _;

                      # Debug request details
                      add_header X-Debug-Host $host;
                      add_header X-Debug-Uri $request_uri;

                      location / {
                          # This maps the request path correctly - using literal variable
                          rewrite ^/(.*) /authdev3/$1 break;

                          # Set the proper Host header for API Gateway
                          proxy_set_header Host ${Authdev3ApiGatewayId}.execute-api.eu-west-2.amazonaws.com;

                          # Pass the actual VPC endpoint - without https:// in proxy_pass
                          proxy_pass https://vpce-0b907325ae3bfe3ce-0q79qfb6.execute-api.eu-west-2.vpce.amazonaws.com;

                          # Forward the authorization header
                          proxy_set_header Authorization $http_authorization;
                          proxy_pass_request_headers on;

                          # Add additional headers for debugging
                          proxy_set_header X-Real-IP $remote_addr;
                          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                          proxy_set_header X-Original-URI $request_uri;

                          # SSL verification settings for connecting to VPC endpoint
                          proxy_ssl_verify off;
                      }
                  }
                owner: root:root
                permissions: '0644'
              - path: /etc/sudoers.d/ssm-agent-users
                content: |
                  # User rules for ssm-user
                owner: root:root
                permissions: '0440'

            runcmd:
              - systemctl enable nginx
              - systemctl start nginx
          - Authdev3ApiGatewayId:
              Fn::ImportValue: !Sub "${Authdev3ApiStackName}-AccountManagementApiId"
      Tags:
        - Key: Name
          Value: authdev3-am-api-proxy-host
Outputs:
  DevProxyInstanceId:
    Description: Instance ID of the Dev proxy
    Value: !Ref DevProxyInstance
    Export:
      Name: !Sub "${AWS::StackName}-DevProxyInstanceId"

  SSMDocumentName:
    Description: Name of the SSM document for port forwarding
    Value: !Ref DevPortForwardDocument
    Export:
      Name: !Sub "${AWS::StackName}-SSMDocumentName"

  Authdev3ProxyInstanceId:
    Description: Instance ID of the authdev3 proxy
    Value: !Ref Authdev3ProxyInstance
    Export:
      Name: !Sub "${AWS::StackName}-Authdev3ProxyInstanceId"

  Authdev3SSMDocumentName:
    Description: Name of the SSM document for authdev3 port forwarding
    Value: !Ref Authdev3PortForwardDocument
    Export:
      Name: !Sub "${AWS::StackName}-Authdev3SSMDocumentName"
