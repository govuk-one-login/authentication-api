AWSTemplateFormatVersion: "2010-09-09"
Resources:
  AccountManagementApi:
    Type: AWS::Serverless::Api
    Properties:
      Name: !Sub
        - ${Env}-di-account-management-api-method-management
        - Env: !If [UseSubEnvironment, !Ref SubEnvironment, !Ref Environment]
      StageName: !If [UseSubEnvironment, !Ref SubEnvironment, !Ref Environment]
      AlwaysDeploy: true
      AccessLogSetting:
        DestinationArn: !GetAtt AccountManagementApiAccessLogGroup.Arn
        Format:
          Fn::ToJsonString:
            requestId: $context.requestId
            ip: $context.identity.sourceIp
            userAgent: $context.identity.userAgent
            requestTime: $context.requestTime
            httpMethod: $context.httpMethod
            resourcePath: $context.resourcePath
            status: $context.status
            protocol: $context.protocol
            responseLength: $context.responseLength
            integrationStatus: $context.integration.integrationStatus
            integrationLatency: $context.integration.latency
            integrationRequestId: $context.integration.requestId
      EndpointConfiguration:
        Type: PRIVATE
        VpcEndpointIds:
          - Fn::ImportValue: !Sub "${VpcStackName}-ExecuteApiGatewayEndpointId"
          - Fn::If:
              - AddHomeApiVpcEndpointId
              - Fn::Select:
                  - 0
                  - !FindInMap [
                      EnvironmentConfiguration,
                      !Ref Environment,
                      HomeApiVpcEndpointId,
                      DefaultValue: [],
                    ]
              - !Ref AWS::NoValue
          - Fn::If:
              - AddHomeApiVpcEndpointId
              - Fn::Select:
                  - 1
                  - !FindInMap [
                      EnvironmentConfiguration,
                      !Ref Environment,
                      HomeApiVpcEndpointId,
                      DefaultValue: [],
                    ]
              - !Ref AWS::NoValue
      Auth:
        ResourcePolicy:
          CustomStatements:
            - Sid: "AllowAll"
              Effect: Allow
              Action: "execute-api:Invoke"
              Principal: "*"
              Resource: "execute-api:/*"
            - Sid: "EnforceVpcEndpointAccess"
              Effect: Deny
              Action: "execute-api:Invoke"
              Principal: "*"
              Resource: "execute-api:/*"
              Condition:
                StringNotEquals:
                  aws:SourceVpce:
                    - Fn::ImportValue: !Sub "${VpcStackName}-ExecuteApiGatewayEndpointId"
                    - Fn::If:
                        - AddHomeApiVpcEndpointId
                        - Fn::Select:
                            - 0
                            - !FindInMap [
                                EnvironmentConfiguration,
                                !Ref Environment,
                                HomeApiVpcEndpointId,
                                DefaultValue: [],
                              ]
                        - !Ref AWS::NoValue
                    - Fn::If:
                        - AddHomeApiVpcEndpointId
                        - Fn::Select:
                            - 1
                            - !FindInMap [
                                EnvironmentConfiguration,
                                !Ref Environment,
                                HomeApiVpcEndpointId,
                                DefaultValue: [],
                              ]
                        - !Ref AWS::NoValue
      DefinitionBody:
        Fn::Transform:
          Name: AWS::Include
          Parameters:
            Location: "./ci/openAPI/AccountManagementMMApi.yaml"
      OpenApiVersion: 3.0.1
      Tags:
        - Key: FMSRegionalPolicy
          Value: "false"
        - Key: CustomPolicy
          Value:
            !FindInMap [
              EnvironmentConfiguration,
              !If [UseSubEnvironment, !Ref SubEnvironment, !Ref Environment],
              AMApiFMSTagValue,
            ]

  AccountManagementApiAccessLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId: !GetAtt MainKmsKey.Arn
      LogGroupName: !Sub
        - "${Env}-AccountManagement-api-access-logs"
        - Env: !If [UseSubEnvironment, !Ref SubEnvironment, !Ref Environment]
      RetentionInDays:
        !FindInMap [
          EnvironmentConfiguration,
          !Ref Environment,
          cloudwatchLogRetentionInDays,
        ]
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-AccountManagementApiAccessLogGroup"
        - Key: Environment
          Value: !Ref Environment
        - Key: Source
          Value: govuk-one-login/authentication-api/ci/cloudformation/account-management/api/account-management-method-management-api

  AccountManagementApiAccessLogSubscriptionFilter:
    Condition: IsSplunkEnabled
    Type: AWS::Logs::SubscriptionFilter
    Properties:
      DestinationArn: !Ref LoggingSubscriptionEndpointArn
      FilterPattern: ""
      LogGroupName: !Ref AccountManagementApiAccessLogGroup

  AccountManagementApiExecutionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId: !GetAtt MainKmsKey.Arn
      LogGroupName: !Sub
        - API-Gateway-Execution-Logs_${AccountManagementApi}/${StageName}
        - StageName:
            !If [UseSubEnvironment, !Ref SubEnvironment, !Ref Environment]
      RetentionInDays:
        !FindInMap [
          EnvironmentConfiguration,
          !Ref Environment,
          cloudwatchLogRetentionInDays,
        ]
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-AccountManagementApiExecutionLogGroup"
        - Key: Environment
          Value: !Ref Environment
        - Key: Source
          Value: govuk-one-login/authentication-api/ci/cloudformation/account-management/api/account-management-method-management-api

  AccountManagementApiExecutionLogSubscriptionFilter:
    Condition: IsSplunkEnabled
    Type: AWS::Logs::SubscriptionFilter
    Properties:
      DestinationArn: !Ref LoggingSubscriptionEndpointArn
      FilterPattern: ""
      LogGroupName: !Ref AccountManagementApiExecutionLogGroup

Outputs:
  AccountManagementApiId:
    Value: !Ref AccountManagementApi
    Export:
      Name: !Sub "${AWS::StackName}-AccountManagementApiId"

  AccountManagementApiRootResourceId:
    Value: !GetAtt AccountManagementApi.RootResourceId
    Export:
      Name: !Sub "${AWS::StackName}-AccountManagementApiRootResourceId"
